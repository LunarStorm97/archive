name: Upload to Release

on:
  workflow_dispatch:
    inputs:
      DOWNLOAD_URL:
        description: Download URL
        required: true
        default: https://software.download.prss.microsoft.com/dbazure/Win11_24H2_English_x64.iso?t=7a9fa3e6-fbdf-4360-b36d-f741af09ab27&P1=1740193241&P2=601&P3=2&P4=TxXKGXyAUpJ24FzDF5Q%2bWy5OIbthgFbLuL53SPrB8ygofj7tROhIrSqOu0f1J5I2xP7SKp6Dyw%2bkJSM%2fvrB%2fOtvi2XOgFXXR1p4qLS17TAfUa85t8%2buU8UlX4zo39H%2bf4Y3RdcUm3aHr5jwKId%2bqT0U9b9bGu6PmDMaPQo7raHBbbhGDBHTjpL%2bvzxkRxv3nlxQQNsCnMHsqySS4gCNQtwwRBwwdq56bdt%2bSHmoVSVWikLfMwXztTVJuLhGCDRrH2ykTL5SWvGeRmhz3oRF3h0pC8Pf3F4NVwSF4LIEx728aMgZhD3wZcMrlalO44SrLs8VK7I3VcrzIBYRyddl7mQ%3d%3d

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Prepare environment
        run: |
          sudo mkdir -p /mnt/workspace
          sudo chown $USER:$USER /mnt/workspace

      - name: Download file
        working-directory: /mnt/workspace
        run: |
          wget --no-check-certificate --content-disposition "${{ github.event.inputs.DOWNLOAD_URL }}"
          FILE_NAME=$(ls)
          echo FILE_NAME=$FILE_NAME >> $GITHUB_ENV

      - name: Check file size
        working-directory: /mnt/workspace
        run: |
          FILE_SIZE=$(stat -c%s "${{ env.FILE_NAME }}")
          echo FILE_SIZE=$FILE_SIZE >> $GITHUB_ENV

      - name: Split large file
        if: ${{ env.FILE_SIZE >= 2147483648 }}
        working-directory: /mnt/workspace
        run: |
          split -b 1G "${{ env.FILE_NAME }}" "${{ env.FILE_NAME }}_part_"
          rm "${{ env.FILE_NAME }}"

      - name: GH Release
        uses: softprops/action-gh-release@v2.2.1
        with:
          files: /mnt/workspace/*
          name: ${{ env.FILE_NAME }}
          tag_name: ${{ env.FILE_NAME }}
