name: Upload to Release

on:
  workflow_dispatch:
    inputs:
      DOWNLOAD_URL:
        description: "DOWNLOAD_URL"
        required: true
        default: "https://testfile.org/1.3GBiconpng"

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Prepare environment
        run: |
          sudo mkdir -p /mnt/workspace
          sudo chown $USER:$USER /mnt/workspace

      - name: Download
        run: |
          wget --content-disposition ${{ github.event.inputs.DOWNLOAD_URL }} -P /mnt/workspace
          FILE_NAME=$(basename $(ls /mnt/workspace))
          FILE_SIZE=$(stat -c %s /mnt/workspace/$FILE_NAME)
          echo "FILE_NAME=$FILE_NAME" >> $GITHUB_ENV
          echo "FILE_SIZE=$FILE_SIZE" >> $GITHUB_ENV

      - name: Split large files
        if: ${{ env.FILE_SIZE > 2147483648 }}
        run: |
          for file in /mnt/workspace/$FILE_NAME; do
            split -b 1024m $file ${file}_part_
            rm $file
          done

      - name: GH Release
        uses: softprops/action-gh-release@v2.2.1
        with:
          body: |
            DOWNLOAD URL: ${{ github.event.inputs.DOWNLOAD_URL }}
          files: |
            /mnt/workspace/${{ env.FILE_NAME }}*
          name: ${{ env.FILE_NAME }}
          tag_name: ${{ env.FILE_NAME }}
